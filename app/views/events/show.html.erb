<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<h2 class="page-title"><%= @event.title %></h2>
    
    <div class="buttons">
      <%#= link_to "#{t('misc.participant')} (#{@event.boxers.count})", participants_path(@event), :class => "btn" %>
      <% if can? :update, @event %>
        <%= link_to t('buttons.edit'), edit_event_path(@event), :class => "btn" %>
      <% end %>

      <% if can? :destroy, @event %>
        <%= link_to t('buttons.destroy'), @event, method: :delete, data: { confirm: t('messages.confirm_delete') }, :class => "btn delete" %>
      <% end %>
    </div>
    
  <div class="row">
  <% if current_user %>
  <div class="span5">
  <% else %>
  <div class="span10">
  <% end %>
    <legend>Ort und Zeit</legend>
    <div class="info-section">
      
    <% unless @event.date.nil? %>
      <p>
        <label><%= Event.human_attribute_name(:date) %>:</label>
        <%= format_date(@event.date) %>
      </p>
    <% end %>
    
    <% unless @event.schedule_items.empty? %>
      <p>
        <label><%= Event.human_attribute_name(:schedule) %></label>
        <% @event.schedule_items.each do |si| %>
          <%= si.label %>:
          <%= format_time(si.time) %></br>
        <% end %>
      </p>
    <% end %>

    <% unless @event.location.nil? %>
      <p>
        <label><%= Event.human_attribute_name(:location) %>:</label>
        <address>
          <%= @event.location.street %>
          <%= @event.location.number %><br>
          <%= @event.location.zip %>
          <%= @event.location.city %>
        </address>
      </p>

      <div style='width: 100%;'>
        <div id="map" style='width: 100%; height: 250px;'></div>
      </div>

      <script type="text/javascript">
        handler = Gmaps.build('Google');
        handler.buildMap({ provider: {}, internal: {id: 'map'}}, function() {
          markers = handler.addMarkers(<%= raw @hash.to_json %>);
          handler.bounds.extendWith(markers);
          handler.fitMapToBounds();
          handler.getMap().setZoom(15);
        });
      </script>
    <% end %>

  </div>
      
    <legend>Weitere Informationen</legend>
    <div class="info-section">
    
    <% unless @event.additional_info.blank? %>
      <p>
        <%= @event.additional_info %>
      </p>
    <% end %>

    <!--
    <% unless @event.admission.blank? %>
      <p>
        <label><%= Event.human_attribute_name(:admission) %>
        <% unless @event.admission_discounted.blank? %>
          (<%= t('misc.discounted') %>)
        <% end %>
        :</label>
        <%= @event.admission %> €
        <% unless @event.admission_discounted.blank? %>
          (<%= @event.admission_discounted %> €)
        <% end %>
      </p>
    <% end %>
    -->

    <% unless @event.fee.blank? %>
      <p>
        <label><%= Event.human_attribute_name(:fee) %>:</label>
        <%= @event.fee %> €
      </p>
    <% end %>

      <p>
      <label>Zugelassene Alters- und <%= PerformanceClass.model_name.human(count: 2) %>:</label>
        <% unless @event.performance_classes.empty? then %>
          <ul>
            <% @event.performance_classes.each do |pc| %>
              <li><%= pc.title %></li>
            <% end %>
          </ul>
        <% else %>alle<% end %>
      </p>

    </div>
    
    <legend><%= t('misc.contact') %></legend>
      <div class="info-section">
        
        <p>
          <label><%= t('misc.host') %>:</label>
          <%= link_to @event.club.name, club_path(@event.club.id), :class => "link" %>
        </p>
    
        <% if @event.contact_name &&  @event.contact_name_public %>
          <p>
            <strong><%= Event.human_attribute_name(:contact_name) %>:</strong>
            <%= @event.contact_name %>
          </p>
        <% end %>

        <% if @event.contact_phone && @event.contact_phone_public %>
          <p>
            <strong><%= Event.human_attribute_name(:contact_phone) %>:</strong>
            <%= @event.contact_phone %>
          </p>
        <% end %>

        <% if @event.contact_mail && @event.contact_mail_public %>
          <p>
            <strong><%= Event.human_attribute_name(:contact_mail) %>:</strong>
            <a href="mailto:<%= @event.contact_mail %>"><%= @event.contact_mail %></a>
          </p>
        <% end %>
      </div>

    </div>

    <div class="span4">
      <% if current_user && (current_user.admin? || @event.club_id == current_user.id) %>

        <legend>Veranstaltung genehmigt?</legend>
        <div class="approved info-section">
  
          <% if @event.approved.nil? then %>
            <%= image_tag "pending.png", :alt => "Offen", :width => 20 %> <span>Offen</span>
          <% elsif @event.approved then %>
            <%= image_tag "approved.png", :alt => "Ja", :width => 20 %> <span>Ja</span>
          <% else %>
            <%= image_tag "declined.png", :alt => "Nein", :width => 20 %> <span>Nein</span>
          <% end %>

          <% if can? :manage, @event and !@event.approved then %>

            <div id="approve-buttons" class="actions form-actions">
  
              <%= form_for(@event, :remote => true, :class => "approve_form", :html => {:onsubmit => "approve_event()"}) do |f| %>
                <%= f.hidden_field :approved, value: true %>
                <%= f.submit t('buttons.approve'), :class => "btn btn-primary" %>
              <% end %>

              <%= form_for(@event, :remote => true, :class => "approve_form", :html => {:onsubmit => "decline_event()"}) do |f| %>
                <%= f.hidden_field :approved, value: false %>
                <%= f.submit t('buttons.decline'), :class => "btn btn-primary delete" %>
              <% end %>
  
            </div>
            
          <% end %>
            
        </div>

      <% end %>
      
      <% if current_user && @event.approved then %>

        <legend>Meine <%= t('misc.participant') %></legend>
        <div class="participations info-section">
          
          <div class="apply buttons">
            <% if can? :apply, @event %>
                <p class="subtitle">Anmeldungen bis <%= format_date(@event.get_deadline) %></p>
                <%= link_to t('buttons.apply', :item => Boxer.model_name.human), application_path(@event.id), :class => "btn btn-primary" %>
            <% else %>
                <p class="subtitle">Anmeldefrist abgelaufen.</p>
            <% end %>
          </div>
  
          <% unless @boxers_applied.empty? then %>
            <p>Folgende Boxer sind angemeldet:</p>
            <table class="table">
              <tbody>
                <% @boxers_applied.each do |b| %>
                <tr>
                  <td><%= b.get_name %></td>
                  <% if @event.upcoming? %>
                    <td><%= link_to t('buttons.undo_application'), undo_application_path(@event.id, b.id), method: :delete, data: { confirm: t('messages.confirm_delete') }, :class => "link" %></td>
                  <% end %>
                </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>

        </div>

      <% end %>
  
      
    
  </div>

</div>
